#!/bin/sh -efu
#
# Copyright (c) 2018-2019 The strace developers.
# All rights reserved.
#
# SPDX-License-Identifier: GPL-2.0-or-later

. "${srcdir=.}/scno_tampering.sh"

: ${IOCTL_INJECT_START=256}
: ${IOCTL_RETVAL=42}

run_strace -a20 "$@" -e trace=ioctl \
	-e inject=ioctl:retval="${IOCTL_RETVAL}":when="${IOCTL_INJECT_START}+" \
	"../$NAME" \
	"${IOCTL_INJECT_START}" "${IOCTL_RETVAL}"> "$EXP.${IOCTL_RETVAL}"

grep -v '^ioctl([012][,<]' < "$LOG" > "$OUT.$IOCTL_RETVAL"
match_diff "$OUT.$IOCTL_RETVAL" "$EXP.$IOCTL_RETVAL"
